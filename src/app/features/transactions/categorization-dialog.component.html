<div class="categorization-dialog">
  <!-- Header -->
  <div class="dialog-header">
    <div class="header-left">
      <mat-icon [class.spinning]="job?.status === 'processing'">
        {{ job?.status === 'processing' ? 'sync' : 'category' }}
      </mat-icon>
      <h2>AI Categorization</h2>
      <mat-chip-set *ngIf="job">
        <mat-chip [style.background-color]="getStatusColor()" class="status-chip">
          {{ getStatusLabel() }}
        </mat-chip>
      </mat-chip-set>
    </div>
    <div class="header-actions">
      <button mat-icon-button
              *ngIf="job?.status === 'processing'"
              (click)="pauseJob()"
              matTooltip="Pause">
        <mat-icon>pause</mat-icon>
      </button>
      <button mat-icon-button
              *ngIf="job?.status === 'paused'"
              (click)="resumeJob()"
              matTooltip="Resume">
        <mat-icon>play_arrow</mat-icon>
      </button>
      <button mat-icon-button (click)="close()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>

  <mat-dialog-content>
    <!-- Progress Stats -->
    <div class="stats-bar" *ngIf="status">
      <div class="stat-item">
        <div class="stat-value">{{ status.processedCount }}</div>
        <div class="stat-label">Processed</div>
      </div>
      <div class="stat-item success">
        <div class="stat-value">{{ status.appliedCount }}</div>
        <div class="stat-label">Applied</div>
      </div>
      <div class="stat-item corrected" *ngIf="status.correctedCount > 0">
        <div class="stat-value">{{ status.correctedCount }}</div>
        <div class="stat-label">Corrected</div>
      </div>
      <div class="stat-item total">
        <div class="stat-value">{{ status.totalCount }}</div>
        <div class="stat-label">Total</div>
      </div>
      <div class="progress-section">
        <mat-progress-bar
          mode="determinate"
          [value]="status.progress"
          [color]="job?.status === 'paused' ? 'warn' : 'primary'">
        </mat-progress-bar>
        <span class="progress-text">{{ status.progress }}%</span>
      </div>
    </div>

    <!-- Results List -->
    <div class="results-section">
      <h3>
        <mat-icon>list</mat-icon>
        Recent Results
        <span class="results-count">({{ job?.results?.length || 0 }})</span>
      </h3>

      <div class="results-list" *ngIf="job?.results?.length">
        <mat-expansion-panel *ngFor="let result of getDisplayResults(); let i = index"
                              [class.applied]="result.status === 'applied'"
                              [class.corrected]="result.status === 'corrected'"
                              [class.error]="result.status === 'error'"
                              [class.skipped]="result.status === 'skipped'">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <div class="result-header">
                <mat-icon class="status-icon" [matTooltip]="getResultStatusTooltip(result)">
                  {{ getResultStatusIcon(result) }}
                </mat-icon>
                <div class="result-info">
                  <span class="result-description">{{ result.transactionDescription | slice:0:50 }}</span>
                  <span class="result-amount">{{ result.transactionAmount | currency:'EUR' }}</span>
                </div>
              </div>
            </mat-panel-title>
            <mat-panel-description>
              <div class="result-category">
                <span class="category-name">
                  {{ result.correctedCategory || result.suggestedCategory }}
                  <span *ngIf="result.correctedSubcategory || result.suggestedSubcategory">
                    > {{ result.correctedSubcategory || result.suggestedSubcategory }}
                  </span>
                </span>
                <mat-chip class="confidence-chip"
                          [style.background-color]="getConfidenceColor(result.confidence)">
                  {{ result.confidence }}%
                </mat-chip>
              </div>
            </mat-panel-description>
          </mat-expansion-panel-header>

          <div class="result-detail">
            <div class="detail-row">
              <span class="detail-label">Beneficiary:</span>
              <span class="detail-value">{{ result.transactionBeneficiary || 'N/A' }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Reasoning:</span>
              <span class="detail-value">{{ result.reasoning }}</span>
            </div>
            <div class="detail-row" *ngIf="result.linkedOrderDetails?.length">
              <span class="detail-label">Linked Orders:</span>
              <span class="detail-value">{{ result.linkedOrderDetails!.join(', ') }}</span>
            </div>
            <div class="detail-row" *ngIf="result.errorMessage">
              <span class="detail-label error">Error:</span>
              <span class="detail-value error">{{ result.errorMessage }}</span>
            </div>

            <!-- Correction Form -->
            <div class="correction-form" *ngIf="result.status !== 'error'">
              <mat-divider></mat-divider>
              <h4>Correct this categorization</h4>
              <div class="correction-fields">
                <mat-form-field appearance="outline">
                  <mat-label>Category</mat-label>
                  <mat-select [(ngModel)]="correctionData[result.transactionId].category">
                    <mat-option *ngFor="let cat of categories" [value]="cat.name">
                      {{ cat.name }}
                    </mat-option>
                    <mat-option value="__new__">+ Add New Category</mat-option>
                  </mat-select>
                </mat-form-field>
                <mat-form-field appearance="outline" *ngIf="correctionData[result.transactionId].category === '__new__'">
                  <mat-label>New Category Name</mat-label>
                  <input matInput [(ngModel)]="correctionData[result.transactionId].newCategory">
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Subcategory (optional)</mat-label>
                  <input matInput [(ngModel)]="correctionData[result.transactionId].subcategory">
                </mat-form-field>
              </div>
              <div class="correction-options">
                <mat-checkbox [(ngModel)]="correctionData[result.transactionId].createRule">
                  Create rule from this correction
                </mat-checkbox>
              </div>
              <div class="correction-actions">
                <button mat-stroked-button
                        color="primary"
                        [disabled]="!canCorrect(result.transactionId)"
                        (click)="submitCorrection(result)">
                  <mat-icon>check</mat-icon>
                  Apply Correction
                </button>
              </div>
            </div>
          </div>
        </mat-expansion-panel>
      </div>

      <div class="no-results" *ngIf="!job?.results?.length">
        <mat-icon>hourglass_empty</mat-icon>
        <span>Waiting for results...</span>
      </div>
    </div>

    <!-- Conversation Section -->
    <div class="conversation-section" *ngIf="job">
      <mat-divider></mat-divider>
      <h3>
        <mat-icon>chat</mat-icon>
        Ask AI
      </h3>
      <div class="conversation-messages" *ngIf="job.conversationHistory?.length">
        <div *ngFor="let msg of job.conversationHistory"
             class="message"
             [class.user]="msg.role === 'user'"
             [class.assistant]="msg.role === 'assistant'">
          <mat-icon class="message-icon">{{ msg.role === 'user' ? 'person' : 'smart_toy' }}</mat-icon>
          <div class="message-content">{{ msg.content }}</div>
        </div>
      </div>
      <div class="chat-input">
        <mat-form-field appearance="outline" class="chat-field">
          <mat-label>Ask about categorizations...</mat-label>
          <input matInput
                 [(ngModel)]="chatMessage"
                 (keyup.enter)="sendMessage()"
                 [disabled]="isSendingMessage">
        </mat-form-field>
        <button mat-icon-button
                color="primary"
                [disabled]="!chatMessage.trim() || isSendingMessage"
                (click)="sendMessage()">
          <mat-icon>send</mat-icon>
        </button>
      </div>
    </div>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button (click)="close()">Close</button>
    <button mat-raised-button
            color="warn"
            *ngIf="job?.status === 'processing' || job?.status === 'paused'"
            (click)="cancelJob()">
      <mat-icon>stop</mat-icon>
      Cancel Job
    </button>
  </mat-dialog-actions>
</div>
